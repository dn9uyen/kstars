name: Build KStars (macOS arm64)

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: kstars-macos-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 180

    defaults:
      run:
        shell: bash

    env:
      CRAFT_PREFIX: ${{ github.workspace }}/.craftroot
      CRAFT_DOWNLOAD_CACHE: ${{ github.workspace }}/.craft-download-cache
      CRAFT_BRANCH: master
      HOMEBREW_NO_AUTO_UPDATE: "1"
      HOMEBREW_NO_ANALYTICS: "1"

    steps:
      - name: Checkout (your fork)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: recursive

      - name: Setup Python (toolcache)
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Create venv for Craft bootstrap
        run: |
          set -euxo pipefail
          python -V
          python -m venv "$GITHUB_WORKSPACE/.craft-bootstrap-venv"
          echo "VENV_PY=$GITHUB_WORKSPACE/.craft-bootstrap-venv/bin/python" >> "$GITHUB_ENV"
          "$GITHUB_WORKSPACE/.craft-bootstrap-venv/bin/python" -m pip install -U pip

      - name: Cache Craft downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.CRAFT_DOWNLOAD_CACHE }}
          key: macos-arm64-craft-${{ env.CRAFT_BRANCH }}-download-v7
          restore-keys: |
            macos-arm64-craft-${{ env.CRAFT_BRANCH }}-download-

      - name: Bootstrap KDE Craft (force macOS, select arm64)
        run: |
          set -euxo pipefail
          unset ANDROID_SDK_ROOT ANDROID_HOME

          rm -rf "$CRAFT_PREFIX"
          mkdir -p "$CRAFT_PREFIX" "$CRAFT_DOWNLOAD_CACHE"
          ln -sfn "$CRAFT_DOWNLOAD_CACHE" "$CRAFT_PREFIX/download"

          curl -L "https://raw.githubusercontent.com/KDE/craft/${CRAFT_BRANCH}/setup/CraftBootstrap.py" -o setup.py
          # macOS prompt: [0] x86_64, [1] arm64 -> choose 1
          printf "1\n\n" | "$VENV_PY" setup.py --prefix "$CRAFT_PREFIX" --branch "$CRAFT_BRANCH"

      - name: Patch CraftSettings.ini (disable tests + force binary cache)
        run: |
          set -euxo pipefail
          SETTINGS="$CRAFT_PREFIX/etc/CraftSettings.ini"
          test -f "$SETTINGS"

          python - <<'PY'
          import re, os, pathlib

          p = pathlib.Path(os.environ["CRAFT_PREFIX"]) / "etc" / "CraftSettings.ini"
          s = p.read_text()

          def set_in_section(text, section, key, value):
            # Ensure section exists
            if not re.search(rf"(?m)^\[{re.escape(section)}\]\s*$", text):
              text += f"\n[{section}]\n"
            # Insert or replace key in section
            sec_re = re.compile(rf"(?ms)^\[{re.escape(section)}\]\s*$.*?(?=^\[|\Z)")
            m = sec_re.search(text)
            block = m.group(0)

            key_re = re.compile(rf"(?m)^\s*{re.escape(key)}\s*=\s*.*$")
            if key_re.search(block):
              block2 = key_re.sub(f"{key} = {value}", block)
            else:
              # Insert after section header line
              lines = block.splitlines()
              lines.insert(1, f"{key} = {value}")
              block2 = "\n".join(lines) + ("\n" if not block.endswith("\n") else "")
            return text[:m.start()] + block2 + text[m.end():]

          s = set_in_section(s, "Compile", "BuildTests", "False")
          s = set_in_section(s, "Packager", "UseCache", "True")

          p.write_text(s)
          print("Patched", p)
          PY

      - name: Sanity check Craft configuration (ABI + BuildTests OFF + UseCache ON)
        run: |
          set -euxo pipefail
          SETTINGS="$CRAFT_PREFIX/etc/CraftSettings.ini"
          echo "---- ABI ----"
          grep -E '^\s*ABI\s*=' "$SETTINGS" || true
          if ! grep -qE '^\s*ABI\s*=\s*macos-' "$SETTINGS"; then
            echo "ERROR: Craft ABI is not macOS."
            exit 1
          fi

          echo "---- Compile ----"
          awk 'BEGIN{p=0} /^\[Compile\]/{p=1} p{print} /^\[/{if(p && $0!="[Compile]") exit}' "$SETTINGS" || true
          if ! grep -qE '^\s*BuildTests\s*=\s*False\b' "$SETTINGS"; then
            echo "ERROR: BuildTests is not False (would trigger Boost.Test failures)."
            exit 1
          fi

          echo "---- Packager ----"
          awk 'BEGIN{p=0} /^\[Packager\]/{p=1} p{print} /^\[/{if(p && $0!="[Packager]") exit}' "$SETTINGS" || true
          if ! grep -qE '^\s*UseCache\s*=\s*True\b' "$SETTINGS"; then
            echo "ERROR: UseCache is not True (could cause 2h source builds)."
            exit 1
          fi

      - name: Build KStars from this repo checkout (no forced rebuild)
        run: |
          set -euxo pipefail
          unset ANDROID_SDK_ROOT ANDROID_HOME

          set +u
          source "$CRAFT_PREFIX/craft/craftenv.sh"
          set -u

          # Resolve package name (blueprint path can vary)
          PKG="kstars"
          if craft --search kstars | grep -qiE 'kde/applications/kstars'; then
            PKG="kde/applications/kstars"
          elif craft --search kstars | grep -qiE 'kde/education/kstars'; then
            PKG="kde/education/kstars"
          fi
          echo "Using Craft package: $PKG"

          # No --no-cache, no --ignoreInstalled
          craft \
            --options "$PKG.srcDir=$GITHUB_WORKSPACE" \
            "$PKG"

      - name: Package DMG (should not rebuild)
        run: |
          set -euxo pipefail
          unset ANDROID_SDK_ROOT ANDROID_HOME

          set +u
          source "$CRAFT_PREFIX/craft/craftenv.sh"
          set -u

          PKG="kstars"
          if craft --search kstars | grep -qiE 'kde/applications/kstars'; then
            PKG="kde/applications/kstars"
          elif craft --search kstars | grep -qiE 'kde/education/kstars'; then
            PKG="kde/education/kstars"
          fi
          echo "Using Craft package: $PKG"

          craft \
            --options "$PKG.srcDir=$GITHUB_WORKSPACE" \
            --package "$PKG"

      - name: Collect artifacts
        run: |
          set -euxo pipefail
          mkdir -p artifacts
          find "$CRAFT_PREFIX/tmp" -maxdepth 2 -name "*.dmg" -print -exec cp -v {} artifacts/ \; || true
          cp -v "$CRAFT_PREFIX/etc/CraftSettings.ini" artifacts/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kstars-macos-arm64
          path: artifacts
