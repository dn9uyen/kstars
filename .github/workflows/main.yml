name: Build KStars (macOS arm64)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

jobs:
  build-macos-arm64:
    runs-on: macos-14

    env:
      CRAFT_ROOT: ${{ github.workspace }}/.craftroot
      CRAFT_TARGET: kde/applications/kstars

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      # Critical: GitHub runners sometimes export Android env vars.
      # If these exist, CraftBootstrap may detect "Android" and pull Android caches/tools.
      - name: Ensure we are NOT in an Android environment
        run: |
          set -euo pipefail
          unset ANDROID_SDK_ROOT ANDROID_HOME || true

      # Use a non-Homebrew Python to avoid PEP 668 "externally-managed-environment".
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install host tools
        run: |
          set -euo pipefail
          brew update
          brew install p7zip ninja

      - name: Bootstrap KDE Craft (Qt6, macOS clang arm64)
        run: |
          set -euo pipefail
          unset ANDROID_SDK_ROOT ANDROID_HOME || true

          mkdir -p "$CRAFT_ROOT"

          # Official bootstrap command from KDE docs uses this script.
          curl -L https://raw.githubusercontent.com/KDE/craft/master/setup/CraftBootstrap.py \
            -o "$RUNNER_TEMP/CraftBootstrap.py"

          # CraftBootstrap prompts on macOS for architecture:
          #   [0] x86_64
          #   [1] arm64
          # Then asks about colored logs (default yes).
          # We answer: "1" then blank (Enter).
          printf "1\n\n" | python "$RUNNER_TEMP/CraftBootstrap.py" --prefix "$CRAFT_ROOT" --branch master

      - name: Show Craft info
        shell: bash
        run: |
          set -euo pipefail
          unset ANDROID_SDK_ROOT ANDROID_HOME || true

          # craftenv.sh is not "set -u" clean; disable nounset just for sourcing.
          set +u
          source "$CRAFT_ROOT/craft/craftenv.sh"
          set -u

          craft --version
          craft --print-settings || true

      - name: Build KStars from this fork (Craft)
        shell: bash
        run: |
          set -euo pipefail
          unset ANDROID_SDK_ROOT ANDROID_HOME || true

          set +u
          source "$CRAFT_ROOT/craft/craftenv.sh"
          set -u

          # Use local checkout as the source dir.
          # Disable libftdi tests to avoid Boost unit_test_framework config failures.
          craft -v --options \
            "kde/applications/kstars.srcDir=$GITHUB_WORKSPACE" \
            "libs/libftdi.buildTests=False" \
            "libs/libftdi.args=-DBUILD_TESTS=OFF -DBUILD_TESTING=OFF" \
            "$CRAFT_TARGET"

      - name: Locate app bundle
        shell: bash
        run: |
          set -euo pipefail
          echo "Looking for KStars app bundle under: $CRAFT_ROOT/Applications"
          find "$CRAFT_ROOT/Applications" -maxdepth 4 -name "KStars*.app" -print || true

      - name: Upload KStars.app artifact
        uses: actions/upload-artifact@v4
        with:
          name: kstars-macos-arm64
          path: |
            .craftroot/Applications/KDE/KStars*.app
