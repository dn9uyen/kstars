name: Build KStars (macOS arm64)

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  build-macos-arm64:
    runs-on: macos-14

    env:
      # Let pip modify Homebrew's EXTERNALLY-MANAGED Python during Craft bootstrap
      PIP_BREAK_SYSTEM_PACKAGES: "1"

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Craft root
        run: |
          echo "CRAFT_ROOT=$RUNNER_TEMP/CraftRoot" >> "$GITHUB_ENV"

      - name: Show runner info
        run: |
          uname -m
          sw_vers
          echo "CRAFT_ROOT=$CRAFT_ROOT"

      - name: Bootstrap KDE Craft (arm64, non-interactive)
        run: |
          curl -L https://raw.githubusercontent.com/KDE/craft/master/setup/CraftBootstrap.py -o setup.py
          # 1 = arm64, then accept default for the next prompt
          printf "1\n\n" | python3 setup.py --prefix "$CRAFT_ROOT"

      - name: Install dependencies (online)
        run: |
          source "$CRAFT_ROOT/craft/craftenv.sh"
          craft --install-deps kde/applications/kstars

      - name: Build KStars from this repo
        run: |
          source "$CRAFT_ROOT/craft/craftenv.sh"
          craft --src-dir "$GITHUB_WORKSPACE" --compile --install --qmerge kde/applications/kstars

      - name: Package DMG
        run: |
          source "$CRAFT_ROOT/craft/craftenv.sh"
          craft --src-dir "$GITHUB_WORKSPACE" --package kde/applications/kstars
          ls -lah "$CRAFT_ROOT/tmp"
          find "$CRAFT_ROOT/tmp" -maxdepth 1 -name "*.dmg" -print

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: kstars-macos-arm64-dmg
          path: ${{ env.CRAFT_ROOT }}/tmp/*.dmg
          if-no-files-found: error
