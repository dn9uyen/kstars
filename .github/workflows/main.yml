name: Build KStars (macOS arm64)

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 180

    defaults:
      run:
        shell: bash

    env:
      CRAFT_PREFIX: ${{ github.workspace }}/.craftroot
      CRAFT_BRANCH: master
      HOMEBREW_NO_AUTO_UPDATE: "1"
      HOMEBREW_NO_ANALYTICS: "1"

    steps:
      - name: Checkout (your fork)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup Python (toolcache)
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Create venv for Craft bootstrap
        run: |
          set -euxo pipefail
          python -m venv "$GITHUB_WORKSPACE/.craft-bootstrap-venv"
          echo "VENV_PY=$GITHUB_WORKSPACE/.craft-bootstrap-venv/bin/python" >> "$GITHUB_ENV"
          "$GITHUB_WORKSPACE/.craft-bootstrap-venv/bin/python" -m pip install -U pip

      - name: Cache Craft downloads
        uses: actions/cache@v4
        with:
          path: ${{ env.CRAFT_PREFIX }}/download
          key: macos-arm64-craft-${{ env.CRAFT_BRANCH }}-download-v4
          restore-keys: |
            macos-arm64-craft-${{ env.CRAFT_BRANCH }}-download-

      - name: Bootstrap KDE Craft (force macOS, select arm64)
        run: |
          set -euxo pipefail

          # IMPORTANT: CraftBootstrap enters Android mode if ANDROID_SDK_ROOT is set. :contentReference[oaicite:1]{index=1}
          unset ANDROID_SDK_ROOT ANDROID_HOME

          # Ensure we don't reuse a previously misconfigured prefix (android ABI etc.)
          rm -rf "$CRAFT_PREFIX"
          mkdir -p "$CRAFT_PREFIX"

          curl -L "https://raw.githubusercontent.com/KDE/craft/${CRAFT_BRANCH}/setup/CraftBootstrap.py" -o setup.py

          # macOS prompt: Select target architecture ["x86_64", "arm64"] (default x86_64). :contentReference[oaicite:2]{index=2}
          # Then colored logs prompt (default Yes) -> empty line accepts default.
          printf "1\n\n" | "$VENV_PY" setup.py --prefix "$CRAFT_PREFIX" --branch "$CRAFT_BRANCH"

      - name: Sanity check ABI is macOS arm64
        run: |
          set -euxo pipefail
          SETTINGS="$CRAFT_PREFIX/etc/CraftSettings.ini"
          test -f "$SETTINGS"
          echo "---- ABI from CraftSettings.ini ----"
          grep -E '^\s*ABI\s*=' "$SETTINGS" || true
          # Must be macos-clang-arm64 (or at least start with macos-)
          if ! grep -qE '^\s*ABI\s*=\s*macos-' "$SETTINGS"; then
            echo "ERROR: Craft ABI is not macOS. Full ABI line:"
            grep -E '^\s*ABI\s*=' "$SETTINGS" || true
            exit 1
          fi

      - name: Build KStars from this repo checkout
        run: |
          set -euxo pipefail
          unset ANDROID_SDK_ROOT ANDROID_HOME

          source "$CRAFT_PREFIX/craft/craftenv.sh"

          if craft --search kstars | grep -qiE 'kde/education/kstars'; then
            PKG="kde/education/kstars"
          else
            PKG="kstars"
          fi

          craft --ignoreInstalled --options "$PKG.srcDir=$GITHUB_WORKSPACE" "$PKG"

      - name: Package DMG
        run: |
          set -euxo pipefail
          unset ANDROID_SDK_ROOT ANDROID_HOME

          source "$CRAFT_PREFIX/craft/craftenv.sh"

          if craft --search kstars | grep -qiE 'kde/education/kstars'; then
            PKG="kde/education/kstars"
          else
            PKG="kstars"
          fi

          craft --options "$PKG.srcDir=$GITHUB_WORKSPACE" --package "$PKG"

      - name: Collect artifacts
        run: |
          set -euxo pipefail
          mkdir -p artifacts
          find "$CRAFT_PREFIX/tmp" -maxdepth 2 -name "*.dmg" -print -exec cp -v {} artifacts/ \; || true
          cp -v "$CRAFT_PREFIX/etc/CraftSettings.ini" artifacts/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kstars-macos-arm64
          path: artifacts
